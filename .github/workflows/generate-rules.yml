name: Generate rule set files

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  main:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y make curl

      - name: Create working directory
        run: |
          rm -rf configs
          mkdir -p configs

      - name: Download SRS files
        working-directory: ./configs
        run: |
          set -e
          urls=(
            "https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-cn.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-cn.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-private.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-cctv.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-bilibili.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-douyin.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-alibaba.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-tencent.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-ads-all.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-httpdns-cn.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-cryptocurrency.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-geolocation-!cn.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-youtube.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-google.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-github.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-openai.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-netflix.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-twitter.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-discord.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-jd.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-apple.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-icloud.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-bilibili-cdn.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-didi.srs"
            "https://raw.githubusercontent.com/jackszb/selfuse-rules/main/wechat.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-tiktok.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-instagram.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-google-gemini.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-facebook.srs"
            "https://raw.githubusercontent.com/jackszb/AdGuardDNSfilter/rule-set/AdGuardSDNSFilter-NoRegex.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-microsoft.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-chinanews.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-hospital-cn.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-reddit.srs"
            "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-onedrive.srs"
          )

          for url in "${urls[@]}"; do
            echo "Downloading $url ..."
            curl -L -O "$url"
          done

          ls -al

      - name: Clone sing-box
        run: git clone --depth 1 https://github.com/SagerNet/sing-box.git

      - name: Build sing-box
        working-directory: ./sing-box
        run: make install

      - name: Decompile SRS files to JSON
        working-directory: ./configs
        run: |
          set -e
          for f in *.srs; do
            sing-box rule-set decompile "$f" -o "${f%.srs}.json"
          done

      - name: Merge JSON rule sets
        working-directory: ./configs
        run: |
          set -e

          sing-box rule-set merge \
            -c geosite-cn.json \
            -c geosite-private.json \
            -c geosite-cctv.json \
            -c geosite-bilibili.json \
            -c geosite-douyin.json \
            -c geosite-alibaba.json \
            -c geosite-tencent.json \
            -c geosite-jd.json \
            -c geosite-apple.json \
            -c geosite-icloud.json \
            -c geosite-bilibili-cdn.json \
            -c geosite-didi.json \
            -c wechat.json \
            -c geosite-microsoft.json \
            -c geosite-chinanews.json \
            -c geosite-category-hospital-cn.json \
            geosite-direct.json

          sing-box rule-set merge \
            -c geosite-category-ads-all.json \
            -c geosite-category-httpdns-cn.json \
            -c geisite-category-cryptocurrency.json \
            -c AdGuardSDNSFilter-NoRegex.json \
            geosite-reject.json

          sing-box rule-set merge \
            -c geosite-geolocation-!cn.json \
            -c geisite-youtube.json \
            -c geisite-google.json \
            -c geisite-github.json \
            -c geisite-openai.json \
            -c geisite-netflix.json \
            -c geisite-twitter.json \
            -c geisite-discord.json \
            -c geisite-tiktok.json \
            -c geisite-instagram.json \
            -c geisite-google-gemini.json \
            -c geisite-facebook.json \
            -c geisite-reddit.json \
            -c geisite-onedrive.json \
            geisite-proxy.json

      - name: Compile SRS files
        working-directory: ./configs
        run: |
          set -e
          sing-box rule-set compile geisite-direct.json -o ../geisite-direct.srs
          sing-box rule-set compile geisite-reject.json -o ../geisite-reject.srs
          sing-box rule-set compile geisite-proxy.json -o ../geisite-proxy.srs
          mv geoip-cn.srs ../geoip-direct.srs

      - name: Clean working directory
        run: rm -rf configs

      - name: List final output files
        run: ls -al geisite-direct.srs geisite-reject.srs geisite-proxy.srs geoip-direct.srs

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"

          git add geisite-direct.srs geisite-reject.srs geisite-proxy.srs geoip-direct.srs

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "[CI] Update rule set files automatically"
            git push
          fi
